<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Jesse Claven</title>
    <link rel="stylesheet" href="https://j-e-s-s-e.com/inter/inter.css">
    <script type="text/javascript" src="https://j-e-s-s-e.com/site.js"></script>
    <link rel="stylesheet" href="/style.css" />
  </head>

  <body>
    <header>
      <div id="title" >
        <h1><a href="https:&#x2F;&#x2F;j-e-s-s-e.com">Jesse Claven</a></h1>
      </div>

      <nav id="hamnav">
        <!-- THE HAMBURGER -->
        <label for="hamburger">&#9776;</label>
        <input type="checkbox" id="hamburger" />

        <!-- MENU ITEMS -->
        <div id="hamitems">
            <a href="https:&#x2F;&#x2F;j-e-s-s-e.com">Home</a>
            <a href="https://j-e-s-s-e.com/notes/">Notes<sup>11</sup></a>
            <a href="https://j-e-s-s-e.com/projects/">Projects<sup>8</sup></a>
            <a href="https://j-e-s-s-e.com/work/">Work<sup>3</sup></a>
            <a href="https://j-e-s-s-e.com/education/">Education</a>
            <a href="https://j-e-s-s-e.com/about/">About</a>
            <a href="https://j-e-s-s-e.com/get-in-touch/">Get in touch</a>
        </div>
      </nav>
    </header>
    <main>
      <div id="notice">
        &#9432; Content (Work, projects, notes, etc.) is being added.
      </div>
      
    <h1 class="title">Serialise and deserialise enums with named associated values from Rust → Swift</h1>
    <p class="subtitle">2023-01-02</p>
        
            Swift
        
            Rust
        
            JSON
        
    
    <p>Between Rust and Serde and Swift and <code>Codable</code>, it's <em>relatively</em> easy to serialise and deserialise between the 2, using JSON. Whilst there aren't shared definitions through a common format, such as Protobuf or MessagePack, for simple data it looks to be maintainable.</p>
<p><code>serde_derive</code> and <code>Codable</code> deally save you writing encoders/serialisers and decoders/deserialisers. For Rust → Swift, I've so far had to write a decoder for enums with named associated values. Both Rust and Swift use nth-indexing for unnamed associated values, so I don't <em>think</em> it would be too hard. Without associated values, decoding worked without having to write anything for decoding.</p>
<p>Here are small snippets of the types and decoder.</p>
<p>Rust<sup class="footnote-reference"><a href="#1">1</a></sup>:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#[</span><span style="color:#bf616a;">derive</span><span>(Debug, Copy, Clone, PartialEq, Deserialize, Serialize)]
</span><span style="color:#b48ead;">pub enum </span><span>State {
</span><span>    Paused { duration: Duration },
</span><span>    Stopped,
</span><span>    Working { duration: Duration },
</span><span>    TakingShortBreak { duration: Duration },
</span><span>    TakingLongBreak { duration: Duration },
</span><span>}
</span></code></pre>
<p>Swift<sup class="footnote-reference"><a href="#2">2</a></sup>:</p>
<pre data-lang="swift" style="background-color:#2b303b;color:#c0c5ce;" class="language-swift "><code class="language-swift" data-lang="swift"><span style="color:#b48ead;">@available</span><span>(macOS </span><span style="color:#d08770;">13</span><span>.</span><span style="color:#d08770;">0</span><span>, *)
</span><span style="color:#b48ead;">enum</span><span> State: Codable {
</span><span>    </span><span style="color:#b48ead;">case</span><span> Paused(duration: Duration)
</span><span>    </span><span style="color:#b48ead;">case</span><span> Stopped
</span><span>    </span><span style="color:#b48ead;">case</span><span> Working(duration: Duration)
</span><span>    </span><span style="color:#b48ead;">case</span><span> TakingShortBreak(duration: Duration)
</span><span>    </span><span style="color:#b48ead;">case</span><span> TakingLongBreak(duration: Duration)
</span><span>
</span><span>    </span><span style="color:#b48ead;">enum</span><span> CodingKeys: String, CodingKey {
</span><span>        </span><span style="color:#b48ead;">case</span><span> Paused
</span><span>        </span><span style="color:#b48ead;">case</span><span> Stopped
</span><span>        </span><span style="color:#b48ead;">case</span><span> Working
</span><span>        </span><span style="color:#b48ead;">case</span><span> TakingShortBreak
</span><span>        </span><span style="color:#b48ead;">case</span><span> TakingLongBreak
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#b48ead;">enum</span><span> AdditionalCodingKeys: String, CodingKey {
</span><span>        </span><span style="color:#b48ead;">case</span><span> duration
</span><span>        </span><span style="color:#b48ead;">case</span><span> secs
</span><span>        </span><span style="color:#b48ead;">case</span><span> nanos
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#b48ead;">init</span><span>(from decoder: Decoder) </span><span style="color:#b48ead;">throws</span><span> {
</span><span>        </span><span style="color:#b48ead;">let</span><span> container = </span><span style="color:#b48ead;">try</span><span> decoder.singleValueContainer()
</span><span>        </span><span style="color:#b48ead;">if let</span><span> state = </span><span style="color:#b48ead;">try</span><span>? container.decode(String.</span><span style="color:#b48ead;">self</span><span>) {
</span><span>            </span><span style="color:#65737e;">// For when it&#39;s &quot;state&quot;:&quot;Stopped&quot;
</span><span>            </span><span style="color:#b48ead;">switch</span><span> state {
</span><span>            </span><span style="color:#b48ead;">case </span><span style="color:#a3be8c;">&quot;Stopped&quot;</span><span>:
</span><span>                </span><span style="color:#b48ead;">self </span><span>= .Stopped
</span><span>            </span><span style="color:#b48ead;">default</span><span>:
</span><span>                fatalError(</span><span style="color:#a3be8c;">&quot;Unexpected value </span><span>\(state)</span><span style="color:#a3be8c;">&quot;</span><span>)
</span><span>            }
</span><span>        } </span><span style="color:#b48ead;">else</span><span> {
</span><span>            </span><span style="color:#65737e;">// For when &quot;state&quot;:{&quot;Working&quot;:{&quot;duration&quot;:{&quot;secs&quot;:1,&quot;nanos&quot;:0}}}
</span><span>            </span><span style="color:#b48ead;">let</span><span> values = </span><span style="color:#b48ead;">try</span><span> decoder.container(keyedBy: CodingKeys.</span><span style="color:#b48ead;">self</span><span>)
</span><span>
</span><span>            </span><span style="color:#65737e;">// Dynamically get the CodingKey for the State from its enum
</span><span>            </span><span style="color:#b48ead;">let</span><span> stateKey = values.allKeys.first!
</span><span>            </span><span style="color:#b48ead;">let</span><span> stateContainer = </span><span style="color:#b48ead;">try</span><span> values.nestedContainer(
</span><span>                keyedBy: AdditionalCodingKeys.</span><span style="color:#b48ead;">self</span><span>, forKey: stateKey
</span><span>            )
</span><span>
</span><span>            </span><span style="color:#b48ead;">let</span><span> durationKey = stateContainer.allKeys.first!
</span><span>            </span><span style="color:#b48ead;">let</span><span> durationContainer = </span><span style="color:#b48ead;">try</span><span> stateContainer.nestedContainer(
</span><span>                keyedBy: AdditionalCodingKeys.</span><span style="color:#b48ead;">self</span><span>, forKey: durationKey
</span><span>            )
</span><span>
</span><span>            </span><span style="color:#b48ead;">let</span><span> nanos = </span><span style="color:#b48ead;">try</span><span> durationContainer.decode(Int.</span><span style="color:#b48ead;">self</span><span>, forKey: .nanos)
</span><span>            </span><span style="color:#b48ead;">let</span><span> secs = </span><span style="color:#b48ead;">try</span><span> durationContainer.decode(Int.</span><span style="color:#b48ead;">self</span><span>, forKey: .secs)
</span><span>
</span><span>            </span><span style="color:#b48ead;">let</span><span> duration = Duration.nanoseconds(nanos) + Duration.seconds(secs)
</span><span>
</span><span>            </span><span style="color:#b48ead;">let</span><span> state: State = {
</span><span>                </span><span style="color:#b48ead;">switch</span><span> stateKey.stringValue {
</span><span>                </span><span style="color:#b48ead;">case </span><span style="color:#a3be8c;">&quot;Paused&quot;</span><span>:
</span><span>                    </span><span style="color:#b48ead;">return</span><span> State.Paused(duration: duration)
</span><span>                </span><span style="color:#b48ead;">case </span><span style="color:#a3be8c;">&quot;Working&quot;</span><span>:
</span><span>                    </span><span style="color:#b48ead;">return</span><span> State.Working(duration: duration)
</span><span>                </span><span style="color:#b48ead;">case </span><span style="color:#a3be8c;">&quot;TakingShortBreak&quot;</span><span>:
</span><span>                    </span><span style="color:#b48ead;">return</span><span> State.TakingShortBreak(duration: duration)
</span><span>                </span><span style="color:#b48ead;">case </span><span style="color:#a3be8c;">&quot;TakingLongBreak&quot;</span><span>:
</span><span>                    </span><span style="color:#b48ead;">return</span><span> State.TakingLongBreak(duration: duration)
</span><span>                </span><span style="color:#b48ead;">default</span><span>:
</span><span>                    fatalError(</span><span style="color:#a3be8c;">&quot;Unexpected value </span><span>\(stateKey.stringValue)</span><span style="color:#a3be8c;">&quot;</span><span>)
</span><span>                }
</span><span>            }()
</span><span>
</span><span>            </span><span style="color:#65737e;">// Fake
</span><span>            </span><span style="color:#b48ead;">self </span><span>= state
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre>
<hr />
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p><a href="https://github.com/jesse-c/y-pomodoro/blob/5e808a251db8971c8987b6f9cd738d5173ba8adc/core/src/lib.rs#L45">jesse-c/y-pomodoro/blob/5e808a251db8971c8987b6f9cd738d5173ba8adc/core/src/lib.rs</a></p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p><a href="https://github.com/jesse-c/y-pomodoro/blob/5e808a251db8971c8987b6f9cd738d5173ba8adc/client/Sources/pomodoro/pomodoro.swift#L72">jesse-c/y-pomodoro/blob/5e808a251db8971c8987b6f9cd738d5173ba8adc/client/Sources/pomodoro/pomodoro.swift</a></p>
</div>


    </main>
  </body>
</html>
